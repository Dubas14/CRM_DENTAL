# Модуль «Календар і запис пацієнтів»

Цей документ описує технічний дизайн модуля календаря для CRM стоматологічної клініки. Він базується на наданій концепції та деталізує дані, сценарії та API, які потрібні для реалізації.

## 1. Цілі та принципи
- **Single Source of Truth**: доступність визначається єдиною часовою моделлю лікаря/кабінету/обладнання.
- **Мінімум ручного втручання**: автоматичні пропозиції слотів, перевірки конфліктів, автоперенесення та нагадування.
- **Швидкість**: побудова слотів <150 мс, відповіді API кешуються.
- **Універсальність**: кастомні тривалості процедур, типи записів, гнучкі графіки та сумісність кабінетів.

## 2. Дані та сутності
### 2.1 Базові
- **Doctor**: `specialization`, `skills`, `default_slot_duration`, `clinic_id`.
- **Schedule**: базові робочі години (`weekday`, `start_time`, `end_time`, `break_start`, `break_end`, `slot_duration_minutes`).
- **ScheduleException**: `date`, `type` (`day_off`, `override`, `busy`), `start_time`, `end_time`, `reason`.
- **Room**: назва, тип, сумісність процедур, окремий календар зайнятості.
- **Equipment**: тип обладнання, календар зайнятості, обмеження процедури.
- **Procedure**: `category`, `base_duration`, `requirements` (кабінет, обладнання, асистент, спеціалізація), можливість етапів.
- **Appointment**: час початку/завершення, статус (`planned`, `confirmed`, `reminded`, `waiting`, `done`, `cancelled`, `no_show`), `doctor_id`, `patient_id`, `room_id`, `procedure_id`, `source`, `is_follow_up`, `comment`.
- **WaitlistRequest**: `patient_id`, `procedure_id`, пріоритет, бажані дати/час, статус.
- **AuditLog**: історія змін записів та розкладів (ACID/трасування).

### 2.2 Додаткові таблиці
- **ProcedureDoctor**: кастомні тривалості процедур для конкретного лікаря.
- **RoomEquipment**: відповідність обладнання кабінетам.
- **AppointmentDependants**: асистент/обладнання, що зарезервовані на слот.

## 3. Алгоритми та сервіси
### 3.1 Engine доступності (FreeSlotsService)
1. Отримати робочі години + винятки лікаря.
2. Побудувати часову сітку з кроком `slot_duration_minutes` (override враховує власну тривалість).
3. Вирахувати зайнятість за:
   - існуючими Appointment (усі статуси, крім `cancelled`, `no_show`),
   - винятками `busy` та `day_off`,
   - зайнятістю Room/Equipment.
4. Відфільтрувати слоти, що накладаються на перерви.
5. Повернути список слотів та причину відсутності, якщо порожньо (`day_off`, `no_schedule`, `invalid_schedule`).

### 3.2 Перевірка конфліктів (ConflictChecker)
- Жорсткі конфлікти: перетин часу лікаря/кабінету/обладнання, відсутність компетенції, недоступний пацієнт, перевищення робочих годин.
- Мʼякі конфлікти: рекомендовані обмеження (пікові години, поспіль >2 процедури, відсутня передоплата).
- API повертає `severity` (`hard`/`soft`) та список проблем; жорсткі блокують створення/перенесення.

### 3.3 Перенесення (RescheduleService)
- Пошук альтернативних слотів на основі тієї ж процедури/кабінету/обладнання.
- Автоматичне оновлення календарів та надсилання нагадувань.
- Оновлення waitlist: якщо слот звільнився, запускається підбір кандидатів.

### 3.4 Список очікування (WaitlistService)
- Зберігає запити «якнайшвидше» з пріоритетом.
- При звільненні слоту формує push/SMS-пропозиції; перший підтверджує слот.
- Підтвердження блокує слот та закриває запит.

### 3.5 Рекомендації (SuggestionService)
- Повертає 5 найближчих вікон для процедури з урахуванням тривалості, сумісності кабінету/обладнання, побажань пацієнта, пікових годин.
- Працює поверх кешованої доступності; підтримує multi-doctor/multi-room.

## 4. API (чернетка)
- `GET /api/doctors/{doctor}/schedule` – базовий розклад + винятки.
- `GET /api/doctors/{doctor}/slots?date=YYYY-MM-DD&procedure_id` – вільні слоти з урахуванням вимог процедури.
- `POST /api/appointments` – створення (конфлікт-чекер всередині), опціонально `room_id`, `procedure_id`.
- `PATCH /api/appointments/{id}` – оновлення статусу, перенесення (через RescheduleService).
- `POST /api/appointments/{id}/reschedule` – отримати/підтвердити альтернативи.
- `POST /api/appointments/{id}/cancel` – скасування із поверненням рекомендацій зі списку очікування.
- `GET /api/appointments/{doctor}?date=YYYY-MM-DD` – події дня/тижня.
- `POST /api/waitlist` – створити запит очікування; `POST /api/waitlist/{id}/accept` – підтвердження пацієнтом.
- `GET /api/waitlist/candidates` – підібрати кандидатів під звільнений слот (доктор/процедура/дата).

## 5. Кешування та продуктивність
- Кеш ключ: `doctor:{id}:availability:{date}` (інвалідація при зміні графіка/винятку/запису/кабінету/обладнання).
- Попереднє обчислення доступності для 7 днів наперед CRON-задачею.
- Використання індексів за `doctor_id`, `room_id`, `start_at`, `end_at` у Appointment/Exceptions.

## 6. Інтеграції
- **Пацієнти**: звʼязок з історією візитів, медкарткою, контактами для нагадувань.
- **Оплати**: перевірка передоплати перед підтвердженням, звʼязування інвойсу з Appointment.
- **Нагадування**: статуси `reminded`/`confirmed`, авто-відмова через посилання.
- **Аналітика**: завантаженість лікарів/кабінетів, no-show rate, конверсія записів.

## 7. UI-орієнтири (для фронтенду)
- Режими календаря: день/тиждень/multi-doctor/multi-room, фільтри за спеціалізаціями.
- Візуальні статуси подій, іконки процедур, панель швидких дій (перенести/скасувати/підтвердити).
- Drag-and-drop з миттєвою перевіркою конфліктів (<50 мс latency).

## 8. План поетапної реалізації
1. **Міграції та моделі**: процедури, кабінети, обладнання, waitlist, audit.
2. **Сервіси**: FreeSlotsService, ConflictChecker, RescheduleService, WaitlistService, SuggestionService.
3. **API**: CRUD для розкладу/винятків, отримання слотів, управління записами, waitlist.
4. **Кеш і нотифікації**: інвалідація кешу, вебхуки/черги для нагадувань.
5. **Аналітика**: агрегати завантаженості, звіти по no-show.

Документ є базовою інструкцією для розробки; кожен сервіс повинен супроводжуватись тестами й інваріантами (ACID для записів).
